## 一、独轮车模型（unicycle model）

<img src="https://raw.githubusercontent.com/Jian-wei-peng/typora-pic/main/202311131004078.png" alt="image-20231113100419010" style="zoom:33%;" />

在 $t$ 时刻，小车的水平方向位置和垂直方向位置分别为$p_{x_{(t)}}$ 和 $p_{y_{(t)}}$，以速度$v_{(t)}$，沿着与水平方向夹角为$\theta_{(t)}$的方向做直线运动，因此可定义系统的状态量为：
$$
\vec{x}_{(t)} = \begin{bmatrix}p_{x_{(t)}} \\ p_{y_{(t)}} \\ v_{(t)} \\ \theta_{(t)}\end{bmatrix}
$$
定义系统的输入（控制量）为：
$$
\vec{u}_{(t)} = \begin{bmatrix}u_{1_{(t)}} \\ u_{2_{(t)}}\end{bmatrix} = \begin{bmatrix}\alpha_{(t)} \\ w_{(t)}\end{bmatrix}
$$

- $\alpha_{(t)}$是加速度；$w_{(t)}$是舵机的角速度

可得到系统的状态方程：
$$
\frac{d\vec{x}_{(t)}}{dt} = \begin{bmatrix}v_{(t)}cos\theta_{(t)} \\ v_{(t)}sin\theta_{(t)} \\ 0 \\ 0\end{bmatrix} + \begin{bmatrix}0 \\ 0 \\ v_{(t)} \\ \theta_{(t)}\end{bmatrix} = f(\vec{x}_{(t)},\vec{u}_{(t)})
$$

- $f(\vec{x}_{(t)},\vec{u}_{(t)})$是非线性的

上述系统是一个**多输入、多状态量的非线性系统**

为便于计算机处理，进行离散化处理（采样时间为$T_s$）：
$$
\vec{x}_{[k+1]} = f_d[\vec{x}_{(t)},\vec{u}_{(t)}]
$$

- $f_d()$表示离散化后的$f()$



## 二、场景一：停车问题

- 假设小车的初始状态为：$\vec{x}_{(0)} = [p_{x_{(0)}}, p_{y_{(0)}}, v_{(0)}, \theta_{(0)}]^T$
- 问题：在未来的某一时刻（$k=N$），小车可以从初始位置移动到目标车位$(p_{x_{(d)}}, p_{y_{(d)}})$，并以水平方向$\theta_{(d)}=0$停在目标点（$v_{(d)}=0$），如图中红色虚线框所示
  - 即**目标状态**为：$\vec{x}_{(d)} = [p_{x_{(d)}}, p_{y_{(d)}}, 0, 0]^T$

<img src="https://raw.githubusercontent.com/Jian-wei-peng/typora-pic/main/202311131021568.png" alt="image-20231113102131434" style="zoom:50%;" />

- **控制目标**：设计一个控制量$\vec{u}_{[k]}$控制小车从初始状态 $\vec{x}_{[0]}$ 转化到目标状态 $\vec{x}_{[d]}$
  - 什么是一个好的控制？
    - 令$k = N$时刻的状态变量 $\vec{x}_{(N)}$ 尽可能地接近 $\vec{x}_d$

### 2.1 代价函数

为实现上述目标，引入一个系统的性能指标：
$$
J = h(x_{[N]} , x_{d}) = (x_{1_{[N]}} - x_{1d})^2 + (x_{2_{[N]}} - x_{2d})^2 + (x_{3_{[N]}} - x_{3d})^2 + (x_{4_{[N]}} - x_{4d})^2
$$

- 取差值的平方是为了避免性能指标出现负值，也可以使用绝对值，但平方更便于数学分析和计算机处理
- 每一个状态变量与目标值之间的差值平方也体现了每一个状态变量的**代价**，差距越大，代价越高，因此 $J$ 也称为代价函数。如果 $J$ 越小，那么$\vec{x}_{[N]}$ 离 $\vec{x}_{[d]}$ 越近
  - 用于评估末端状态与目标状态之间的接近程度

利用离散化表达式（4），可以得到：
$$
\vec{x}_{[1]} = f_d(\vec{x}_{[0]}, \vec{u}_{[0]}) \\
\vec{x}_{[2]} = f_d(f_d(\vec{x}_{[0]}, \vec{u}_{[0]}), \vec{u}_{[1]}) \\
\vec{x}_{[3]} = f_d(f_d(f_d(\vec{x}_{[0]}, \vec{u}_{[0]}), \vec{u}_{[1]}), \vec{u}_{[2]}) \\
\vdots \\
\vec{x}_{[N]} = f_d(\vec{x}_{[N-1]}, \vec{u}_{[N-1]}) = f_d(...(f_d(\vec{x}_{[0]}, \vec{u}_{[0]}), ...), \vec{u}_{[N-1]}) \\
$$

即有：$J = h[f_d(...(f_d(\vec{x}_{[0]}, \vec{u}_{[0]}), ...), \vec{u}_{[N-1]}) , x_{d}]$

- **性能指标 $J$ 与初始状态 $\vec{x}_{[0]}$，目标值 $\vec{x}_{[d]}$ 和控制量 $\vec{u}_{[k]}, k \in [0,N-1]$ 相关**
  - 体现了 “ 设计一个 $\vec{u}[k]$ 控制小车从 $\vec{x}[0]$ 转化到 $\vec{x}[d]$ ”

因此，设计的目标就是：找到一个合适的控制策略：$U^{*} = [\vec{u}_{[0]}, \vec{u}_{[1]}, \vec{u}_{[2]},..., \vec{u}_{[N-1]}]$，使得性能指标 $J$ 最小，即
$$
U^* = argmin J
$$

- $U^*$是一组控制序列，由每一个时刻的控制量组成

### 2.2 矩阵形式

将代价函数（5）写成矩阵形式：
$$
J = (X_{[N]} - X_{d})^T(X_{[N]} - X_{d}) = ||X_{[N]} - X_{d}||^2
$$

- $||X_{[N]} - X_{d}||^2$ 表示 $X_{[N]} - X_{d}$ 的2范数
  - 范数是向量空间中的一个重要函数，具有**距离**的概念
  - 对于一个$n \times 1$的向量$\vec{v} \in R^n$，其2范数为$||v|| = \sqrt{\sum^n_{i=1}\vec{v}^2_i} = \sqrt{\vec{v}^T\vec{v}}$

### 2.3 权重

**在实际问题中，系统中每个状态变量的重要性是不同的**

- **添加一个实数对称半正定矩阵来平衡不同状态变量对性能指标的贡献**

$$
\begin{equation}
    \begin{aligned}
        J &= (\vec{x}_{[N]} - \vec{x}_{d})^T \textcolor{red}{S} (\vec{x}_{[N]} - \vec{x}_{d}) = ||\vec{x}_{[N]} - \vec{x}_{d}||^2_{\textcolor{red}{S}} \\ 
        &= (\vec{x}_{[N]} - \vec{x}_{d})^T 
        \begin{bmatrix} \textcolor{red}{s_1} & 0 & 0 & 0 \\
        				0 & \textcolor{red}{s_2} & 0 & 0 \\ 
        				0 & 0 & \textcolor{red}{s_3} & 0 \\ 
        				0 & 0 & 0 & \textcolor{red}{s_4} 
        \end{bmatrix} 
        (\vec{x}_{[N]} - \vec{x}_{d}) \\
        &= \textcolor{red}{s_1} (\vec{x}_{1_{[N]}} - \vec{x}_{1d})^2 + \textcolor{red}{s_2} (\vec{x}_{2_{[N]}} - \vec{x}_{2d})^2 + \textcolor{red}{s_3} (\vec{x}_{3_{[N]}} - \vec{x}_{3d})^2 + \textcolor{red}{s_4} (\vec{x}_{4_{[N]}} - \vec{x}_{4d})^2
    \end{aligned}
\end{equation}
$$

- 当 $\vec{x}^TS\vec{x} \geq 0$ 时，$S$ 矩阵是半正定的，这保证了性能指标不为负值。同时，对称确保了每一项状态变量权重的一致性
- **通过调整权重矩阵中的参数 $s_1 - s_4$ 可决定不同状态变量在性能指标中的重要程度**
- **注意：**实际问题中，不同状态变量的单位和数量级可能不同，需要对权重系数进行**规范化**处理

### 2.4 约束

为确保系统行为符合实际要求，系统必须要满足一些约束条件，例如：

小车速度可能受到上下限的约束：
$$
v_{min[k]} \leq v_{[k]} \leq v_{max[k]}
$$
控制量的约束：
$$
u_{min[k]} \leq u_{[k]} \leq u_{max[k]}
$$
**在系统控制中必须要严格满足的约束条件，也称为硬约束（hard constraints）**

在约束条件下，$x_{[k]} \in X$，其中 $X$ 被称为状态变量的**容许轨迹（admissible trajectory）**，也可以将约束施加在控制量上，即$u_{[k]} \in \Omega$，其中 $\Omega$ 被称为**容许控制域（set of admissible control）**。在考虑约束条件时，需要保证最优控制算法能够在约束范围内找到可行解，避免过于严格的约束导致问题无解。



## 三、场景二：在1的前提下，考虑能耗问题

考虑能耗时，将输入作为一个重要因素加入性能指标中：
$$
J = ||X_{[N]} - X_{d}||^2_S + \sum^{N-1}_{k=0}||\vec{u}_{[k]}||^2_{R_{[k]}}
$$

- **权重系数的选择不仅要考虑在同一矩阵内，还要和其他权重矩阵进行综合分析比较**
  - 如果 $S$ 大于 $R_{[k]}$ ，那么控制算法就更侧重与末端的状态而忽略能耗
  - 如果 $R_{[k]}$ 大于 $S$，则为了节能，小车可能直接不动了
- $||\vec{u}_{[k]}||^2_{R_{[k]}}$ 也体现了对系统输入**软约束（soft constraints）**的概念。
  - 这一项引入了对控制输入的约束，但不是严格的约束
  - 软约束的引入可以使控制策略更加灵活并增强适应性，**允许在满足主要约束的前提下，对输入的变动和调整有一定的容忍度**



## 四、场景三：轨迹跟踪问题

<img src="https://raw.githubusercontent.com/Jian-wei-peng/typora-pic/main/202311141147353.png" alt="image-20231114114709275" style="zoom:50%;" />

目标轨迹：$[x_{1d_{[k]}}, x_{2d_{[k]}}]^T = [p_{xd_{[k]}}, p_{yd_{[k]}}]^T$

- 与之前的场景不同的是，目标是实时变化的

将性能指标定义为：
$$
J = ||X_{[N]} - X_{d}||^2_S + \sum^{N-1}_{k=0}( ||X_{[k]} - X_{d_{[k]}}||^2_{Q_{[k]}} + ||U_{[k]}||^2_{R_{[k]}})
$$

- $||X_{[N]} - X_{d}||^2_S$ 表示末端状态代价
- $||U_{[k]}||^2_{R_{[k]}}$ 表示控制输入代价
- $\sum^{N-1}_{k=0}||X_{[k]} - X_{d_{[k]}}||^2_{Q_{[k]}}$ 表示状态变量的**运行代价**，用来衡量每个时间步的状态变量与目标轨迹之间的差异



## 五、场景四：轨迹跟踪 + 避障

在二维空间，障碍物的位置由一系列的坐标点来表示，即$(p_{x_{obstacle}}, p_{y_{obstacle}})$

![image-20231114115610104](https://raw.githubusercontent.com/Jian-wei-peng/typora-pic/main/202311141156153.png)

方法一：**增加避障约束条件**
$$
(p_{x_{[k]}}, p_{y_{[k]}}) \notin (p_{x_{obstacle}}, p_{y_{obstacle}})
$$
方法二：**通过软约束来限制小车轨迹和障碍物之间的距离**
$$
J = ||X_{[N]} - X_{d}||^2_S + \sum^{N-1}_{k=0}( ||X_{[k]} - X_{d_{[k]}}||^2_{Q_{[k]}} + ||U_{[k]}||^2_{R_{[k]}}) + D^{-1}((p_{x_{[k]}}, p_{y_{[k]}}),(p_{x_{obstacle}}, p_{y_{obstacle}}))_{P_{[k]}}
$$

- 其中 $D()$ 表示小车在运动过程中每个点到障碍物之间的距离，$D^{-1}()$表示其倒数，$P_{[k]}$是其权重矩阵



**综上所述，给出一个更为严谨的最优控制定义：**

对于一个离散系统：
$$
x_[k+1] = f_d(x_{[k]}, u_{[k]}, k)
$$
最优控制的目标是**找到满足容许控制域的控制策略 $u^*_{[k]} \in \Omega$**，使**系统的状态变量在容许轨迹内（$x_{[k]} \in X$）从初始状态转移到末端状态**，并**令性能指标 $J = h(x_{[N]}, x_{d_[N]}, N) + \sum^{N-1}_{k=0}g(x_{[k]}, x_{d_{[k]}}, u_{[k]}, k)$ 最小**







